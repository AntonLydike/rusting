use std::path::Path;
use std::fs::File;
use std::io::BufWriter;
use rayon::prelude::*;

mod complex;
use complex::*;

type Compl = Complex<f64>;

// predefined color gradient
const COLORS: [(u8,u8, u8); 255] = [(0,7,100), (1,10,103), (2,12,106), (3,15,108), (4,17,111), (4,20,113), (5,22,116), (6,25,118), (7,27,121), (8,29,123), (8,32,126), (9,34,128), (10,37,131), (11,39,133), (11,42,136), (12,44,138), (13,47,141), (14,49,143), (15,51,146), (15,54,148), (16,56,151), (17,59,153), (18,61,156), (18,64,158), (19,66,161), (20,68,163), (21,71,166), (22,73,168), (22,76,171), (23,78,173), (24,81,176), (25,83,178), (25,86,181), (26,88,183), (27,90,186), (28,93,188), (29,95,191), (29,98,193), (30,100,196), (31,103,198), (32,105,201), (32,107,203), (36,110,204), (39,112,205), (42,114,206), (45,116,207), (48,119,207), (51,121,208), (54,123,209), (57,125,210), (60,127,210), (63,130,211), (66,132,212), (69,134,213), (72,136,214), (75,138,214), (78,141,215), (81,143,216), (85,145,217), (88,147,217), (91,149,218), (94,152,219), (97,154,220), (100,156,221), (103,158,221), (106,161,222), (109,163,223), (112,165,224), (115,167,224), (118,169,225), (121,172,226), (124,174,227), (127,176,228), (130,178,228), (133,180,229), (137,183,230), (140,185,231), (143,187,231), (146,189,232), (149,191,233), (152,194,234), (155,196,235), (158,198,235), (161,200,236), (164,202,237), (167,205,238), (170,207,238), (173,209,239), (176,211,240), (179,214,241), (182,216,242), (185,218,242), (189,220,243), (192,222,244), (195,225,245), (198,227,245), (201,229,246), (204,231,247), (207,233,248), (210,236,249), (213,238,249), (216,240,250), (219,242,251), (222,244,252), (225,247,252), (228,249,253), (231,251,254), (234,253,255), (237,255,255), (238,254,251), (238,252,246), (238,251,242), (239,249,237), (239,248,233), (239,246,228), (240,245,224), (240,243,219), (240,242,215), (241,240,210), (241,239,205), (241,237,201), (242,236,196), (242,234,192), (242,233,187), (243,231,183), (243,230,178), (243,228,174), (244,227,169), (244,225,164), (244,224,160), (245,222,155), (245,221,151), (245,219,146), (246,218,142), (246,216,137), (246,215,133), (246,213,128), (247,211,123), (247,210,119), (247,208,114), (248,207,110), (248,205,105), (248,204,101), (249,202,96), (249,201,92), (249,199,87), (250,198,82), (250,196,78), (250,195,73), (251,193,69), (251,192,64), (251,190,60), (252,189,55), (252,187,51), (252,186,46), (253,184,41), (253,183,37), (253,181,32), (254,180,28), (254,178,23), (254,177,19), (255,175,14), (255,174,10), (255,172,5), (255,170,0), (251,168,1), (246,165,2), (242,162,3), (237,159,4), (232,156,5), (228,153,6), (223,151,7), (218,148,8), (214,145,9), (209,142,10), (204,139,10), (200,136,11), (195,134,12), (191,131,13), (186,128,14), (181,125,15), (177,122,16), (172,119,17), (167,117,18), (163,114,19), (158,111,20), (153,108,20), (149,105,21), (144,102,22), (140,100,23), (135,97,24), (130,94,25), (126,91,26), (121,88,27), (116,85,28), (112,83,29), (107,80,30), (102,77,30), (98,74,31), (93,71,32), (89,68,33), (84,66,34), (79,63,35), (75,60,36), (70,57,37), (65,54,38), (61,51,39), (56,49,40), (51,46,40), (47,43,41), (42,40,42), (38,37,43), (33,34,44), (28,32,45), (24,29,46), (19,26,47), (14,23,48), (10,20,49), (5,17,50), (0,14,50), (0,14,52), (0,14,53), (0,13,55), (0,13,56), (0,13,57), (0,12,59), (0,12,60), (0,11,62), (0,11,63), (0,11,64), (0,10,66), (0,10,67), (0,9,69), (0,9,70), (0,9,71), (0,8,73), (0,8,74), (0,7,75), (0,7,77), (0,7,78), (0,6,80), (0,6,81), (0,6,82), (0,5,84), (0,5,85), (0,4,87), (0,4,88), (0,4,89), (0,3,91), (0,3,92), (0,2,94), (0,2,95), (0,2,96), (0,1,98), (0,1,99)];

const MIN_ITERS: u32 = 0;

fn main() {
    let center_r = -0.7439067186973042; // -0.7439067336263865;
    let center_i = -0.13171231234506559; //-0.13170700837611319;
    let scope = 0.000015;

    let iters = 2048*2;
    let size = 5000;
        
    let path = Path::new(r"8bit-rgb-zoom.png");
    let file = File::create(path).unwrap();
    let ref mut w = BufWriter::new(file);

    let mut encoder = png::Encoder::new(w, size, size);
    encoder.set_color(png::ColorType::RGB);
    encoder.set_depth(png::BitDepth::Eight);
    encoder.set_compression(png::Compression::Fast);
    let mut writer = encoder.write_header().unwrap();

    println!("Starting renderer...");

    let data: Vec<u8> = coordinates(size).map(|(x,y)| {
        let val = mb_does_diverge(Complex(
            (x as f64 / size as f64 * scope) - (-center_r + (scope / 2.0)),
            (y as f64 / size as f64 * scope) - (-center_i + (scope / 2.0)),
        ), iters);
        std::iter::once(val.0).chain(std::iter::once(val.1)).chain(std::iter::once(val.2))
    }).flatten_iter().collect();

    println!("Done rendering, now saving...");

    writer.write_image_data(&data).unwrap();

    println!("Done saving...");
}

fn mb_does_diverge(c: Compl, iters: u32) -> (u8, u8, u8) {
    let mut z = c;
    for i in 0..iters {
        z = z.pow(2) + c;
        if z.abs_sq() >= 4.0 {
            let shade = ((i - MIN_ITERS) as f64/ (iters - MIN_ITERS) as f64);
            let shade = shade.sqrt();
            return COLORS[(shade * 255.0) as usize]
        }
    }

    return (0,0,0);
}

fn coordinates(size: u32) -> impl ParallelIterator<Item = (u32, u32)> {
    (0..size).into_par_iter().map(move |i| (0..size).into_par_iter().map(move |r| (r,i))).flatten()
}